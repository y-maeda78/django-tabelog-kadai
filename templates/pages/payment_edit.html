{% extends 'base.html' %}
{% load static %}
{% block title %}お支払方法の変更{% endblock %}

{% block main %}

<!-- ↓↓ main ↓↓ -->
<nav class="mb-3" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'index' %}">HOME</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'mypage' %}">マイページ</a></li> 
                    <li class="breadcrumb-item active" aria-current="page">お支払方法の変更</li>
                </ol>
</nav>

<div class="container pb-5">
    <div class="row justify-content-center">
        <div class="col-xl-5 col-lg-6 col-md-8">

            <h1 class="mb-3 text-center" id="test">お支払方法の変更</h1>

            <div class="container mb-4">
                <div class="row pb-2 mb-2 border-bottom">
                    <div class="col-3">
                        <span class="fw-bold">カード種別</span>
                    </div>

                    <div class="col">
                        <span>{{user.stripe_card_brand}}</span>
                    </div>
                </div>

                <div class="row pb-2 mb-2 border-bottom">
                    <div class="col-3">
                        <span class="fw-bold">カード名義人</span>
                    </div>

                    <div class="col">
                        <span>{{user.stripe_card_name}}</span>
                    </div>
                </div>

                <div class="row pb-2 mb-2 border-bottom">
                    <div class="col-3">
                        <span class="fw-bold">カード番号</span>
                    </div>

                    <div class="col">
                        <span>**** **** **** {{user.stripe_card_no}}</span>
                    </div>
                </div>
            </div>

            <div class="alert alert-danger card-error" id="card-error" role="alert" style="display: none;">
                <ul class="mb-0" id="error-list"></ul>
            </div>

            <div class="text-danger" id="stripe-error"></div>

            <form id="card-form" action="{% url 'subscription_update_save' %}" method="post">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label for="card-holder-name" class="form-label">カード名義人</label>
                    <input type="text" class="form-control" id="card-holder-name" name="card_name" placeholder="カード名義人" required value="{{ user.profile.stripe_card_name }}">
                </div>

                <div class="mb-3">
                    <label class="form-label">カード情報</label>
                    <div id="card-element" class="form-control" style="height: 40px; padding: 10px;">
                    </div>
                </div>
                
                <input type="hidden" name="payment_method_id" id="payment-method-id">

                <div class="d-flex justify-content-center mt-4">
                    <button type="submit" id="submit-button" class="btn btn-primary text-white shadow-sm w-50">変更</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ↑↑ main ↑↑ -->

{% endblock %}
{% block extra_js %}

<script src="https://js.stripe.com/v3/"></script>
<script>

fetch("{% url 'stripe_config' %}")
.then((result) => result.json())
.then((data) => {
    const stripe = Stripe(data.publicKey); 
    const elements = stripe.elements();
    
    const cardElement = elements.create('card', {
        style: { base: { fontSize: '16px' } },
        hidePostalCode: true
    });
    cardElement.mount('#card-element');
    
    const form = document.getElementById('card-form');
    const cardHolderNameInput = document.getElementById('card-holder-name');
    const submitButton = document.getElementById('submit-button');
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitButton.disabled = true;

        // 1. Stripe Payment Methodの生成
        const { paymentMethod, error } = await stripe.createPaymentMethod({
            type: 'card',
            card: cardElement,
            billing_details: {
                name: cardHolderNameInput.value,
            },
        });

        if (error) {
            // エラー表示処理
            console.error(error.message);
            submitButton.disabled = false;
        } else {
            // 2. 成功: Payment Method IDをフィールドにセット
            document.getElementById('payment-method-id').value = paymentMethod.id;
            
            // 3. サーバーへフォームを送信
            form.submit();
        }
    });
});
   

</script>
{% endblock %}